# Kudos to:

# https://docs.aws.amazon.com/codebuild/latest/userguide/build-spec-ref.html
# And... we're assuming Ubuntu.

version: 0.2 # Turns out this matters - https://docs.aws.amazon.com/codebuild/latest/userguide/build-spec-ref.html#build-spec-ref-versions

#env:
#  variables:

# Phase definitions: https://aws.amazon.com/blogs/apn/an-introduction-to-aws-codebuild/

phases:
  install:
    runtime-versions:
      docker: 20
      python: 3.9

  build:
    commands:
      - sam build

      # TODO: ugly hack with the --image-repository switch. fix.
      - sam package --template-file template.yaml --s3-bucket $S3_BUCKET --output-template-file packaged-template.yaml --force-upload  --image-repository 623056247312.dkr.ecr.ap-southeast-2.amazonaws.com/perimeterscanner-app-pipelineoutputregistry-qmeq969nipvp

artifacts:
  files:
    - "**/*"
